

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>AdaptivePELE.simulation.simulationrunner &mdash; AdaptivePELE  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="AdaptivePELE  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> AdaptivePELE
          

          
          </a>

          
            
            
              <div class="version">
                v1.7.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../UserManual.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Problems.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../AdaptivePELE.html">AdaptivePELE â€“ Package Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">AdaptivePELE</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          









<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
        <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>AdaptivePELE.simulation.simulationrunner</li>
    <li class="wy-breadcrumbs-aside">
      
          
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for AdaptivePELE.simulation.simulationrunner</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">import</span> <span class="nn">AdaptivePELE.constants</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.constants</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">blockNames</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.simulation</span> <span class="kn">import</span> <span class="n">simulationTypes</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.atomset</span> <span class="kn">import</span> <span class="n">atomset</span><span class="p">,</span> <span class="n">RMSDCalculator</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.utilities</span> <span class="kn">import</span> <span class="n">utilities</span><span class="p">,</span> <span class="n">PDBLoader</span>
<span class="n">SKLEARN</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">OPENMM</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">MDANALYSIS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SKLEARN</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">subprocess32</span> <span class="k">as</span> <span class="nn">subprocess</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">MDA</span>
    <span class="kn">from</span> <span class="nn">MDAnalysis.analysis</span> <span class="kn">import</span> <span class="n">align</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">MDANALYSIS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">basestring</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">AdaptivePELE.simulation</span> <span class="kn">import</span> <span class="n">openmm_simulations</span> <span class="k">as</span> <span class="n">sim</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">OPENMM</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="ne">FileNotFoundError</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="ne">FileNotFoundError</span> <span class="o">=</span> <span class="ne">IOError</span>


<div class="viewcode-block" id="SimulationParameters"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationParameters">[docs]</a><span class="k">class</span> <span class="nc">SimulationParameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templetizedControlFile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataFolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">documentsFolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peleSteps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitCondition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxCenter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxRadius</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeMovingBox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runEquilibration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationLength</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationMode</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SASAforBox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columnSASA</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectoryName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srun</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srunParameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpiParameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationBoxRadius</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationRotationRange</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationTranslationRange</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="c1"># parameters needed for MD simulations and their defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonBondedCutoff</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Temperature</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningPlatform</span> <span class="o">=</span> <span class="s2">&quot;CPU&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizationIterations</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporterFreq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energyReport</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">productionLength</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ligandName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cofactors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ligandsToRestrict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterBoxSize</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajsPerReplica</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numReplicas</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationLengthNVT</span> <span class="o">=</span> <span class="mi">200000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibrationLengthNPT</span> <span class="o">=</span> <span class="mi">500000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devicesPerTrajectory</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraintsMin</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraintsNVT</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraintsNPT</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxDevicesPerReplica</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="s2">&quot;ff99SB&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customparamspath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postprocessing</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SimulationRunner"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner">[docs]</a><span class="k">class</span> <span class="nc">SimulationRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processorsToClusterMapping</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="SimulationRunner.runSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.runSimulation">[docs]</a>    <span class="k">def</span> <span class="nf">runSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">initialStructuresAsString</span><span class="p">,</span> <span class="n">topologies</span><span class="p">,</span> <span class="n">reportFileName</span><span class="p">,</span> <span class="n">processManager</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SimulationRunner.getWorkingProcessors"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.getWorkingProcessors">[docs]</a>    <span class="k">def</span> <span class="nf">getWorkingProcessors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the number of working processors, i.e. number of trajectories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span></div>

<div class="viewcode-block" id="SimulationRunner.getClusteringInfo"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.getClusteringInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getClusteringInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return information relevant for MSMClustering</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">peleSteps</span></div>

<div class="viewcode-block" id="SimulationRunner.getResname"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.getResname">[docs]</a>    <span class="k">def</span> <span class="nf">getResname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the value of the ligand name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SimulationRunner.getNumReplicas"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.getNumReplicas">[docs]</a>    <span class="k">def</span> <span class="nf">getNumReplicas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the number of replicas, only useful for MD simulations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">numReplicas</span></div>

<div class="viewcode-block" id="SimulationRunner.hasExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.hasExitCondition">[docs]</a>    <span class="k">def</span> <span class="nf">hasExitCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if an exit condition has been set</span>

<span class="sd">            :returns: bool -- True if an exit condition is set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">exitCondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SimulationRunner.checkSimulationInterrupted"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.checkSimulationInterrupted">[docs]</a>    <span class="k">def</span> <span class="nf">checkSimulationInterrupted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputpath</span><span class="p">,</span> <span class="n">restart</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check wether the simulation was interrupted before finishing</span>

<span class="sd">            :param epoch: Epoch number</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">            :param outputpath: Simulation output path</span>
<span class="sd">            :type outputpath: str</span>
<span class="sd">            :param restart: Whether to restart a previous simulation</span>
<span class="sd">            :type restart: bool</span>

<span class="sd">            :returns: bool -- True if the simulations where interrupted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for Pele and Test simulation there is no proper way to check so return</span>
        <span class="c1"># False and rely on the clustering for such check</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SimulationRunner.cleanCheckpointFiles"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.cleanCheckpointFiles">[docs]</a>    <span class="k">def</span> <span class="nf">cleanCheckpointFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Clean the restart files generated if the simulation was interrupted</span>
<span class="sd">            before finishing</span>

<span class="sd">            :param epoch: Epoch number</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for Pele and Test simulation there is no proper way to restart, so</span>
        <span class="c1"># just pass</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SimulationRunner.checkExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.checkExitCondition">[docs]</a>    <span class="k">def</span> <span class="nf">checkExitCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clustering</span><span class="p">,</span> <span class="n">outputFolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if the exit condition has been met</span>

<span class="sd">            :param clustering: Clustering object</span>
<span class="sd">            :type clustering: :py:class:`.Clustering`</span>

<span class="sd">            :returns: bool -- True if the exit condition is met</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">exitCondition</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">EXITCONDITION_TYPE</span><span class="o">.</span><span class="n">METRICMULTIPLETRAJS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">exitCondition</span><span class="o">.</span><span class="n">checkExitCondition</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">exitCondition</span><span class="o">.</span><span class="n">checkExitCondition</span><span class="p">(</span><span class="n">clustering</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulationRunner.makeWorkingControlFile"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.makeWorkingControlFile">[docs]</a>    <span class="k">def</span> <span class="nf">makeWorkingControlFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workingControlFilename</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">inputTemplate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Substitute the values in the templetized control file</span>

<span class="sd">            :param workingControlFilename: Name of the template control file</span>
<span class="sd">            :type workingControlFilename: str</span>
<span class="sd">            :param dictionary: Dictonary containing the parameters to substitute</span>
<span class="sd">                in the control file</span>
<span class="sd">            :param inputFileTemplate: Template control file</span>
<span class="sd">            :type inputFileTemplate: str</span>
<span class="sd">            :type dictionary: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inputTemplate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">templetizedControlFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFile</span><span class="p">:</span>
                <span class="n">inputFileContent</span> <span class="o">=</span> <span class="n">inputFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputFileContent</span> <span class="o">=</span> <span class="n">inputTemplate</span>

        <span class="n">inputFileTemplate</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">inputFileContent</span><span class="p">)</span>
        <span class="n">outputFileContent</span> <span class="o">=</span> <span class="n">inputFileTemplate</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">workingControlFilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outputFile</span><span class="p">:</span>
            <span class="n">outputFileContent</span> <span class="o">=</span> <span class="n">outputFileContent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">outputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputFileContent</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulationRunner.updateMappingProcessors"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.updateMappingProcessors">[docs]</a>    <span class="k">def</span> <span class="nf">updateMappingProcessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update the value of the processorsToClusterMapping, a list with the</span>
<span class="sd">            snapshot from which the trajectories will start in the next iteration</span>

<span class="sd">            :param mapping: List with the snapshot from which the trajectories</span>
<span class="sd">                will start in the next iteration</span>
<span class="sd">            :type mapping: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processorsToClusterMapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></div>

<div class="viewcode-block" id="SimulationRunner.writeMappingToDisk"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.writeMappingToDisk">[docs]</a>    <span class="k">def</span> <span class="nf">writeMappingToDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochDir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the processorsToClusterMapping to disk</span>

<span class="sd">            :param epochDir: Name of the folder where to write the</span>
<span class="sd">                processorsToClusterMapping</span>
<span class="sd">            :type epochDir: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processorsToClusterMapping</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">writeProcessorMappingToDisk</span><span class="p">(</span><span class="n">epochDir</span><span class="p">,</span> <span class="s2">&quot;processorMapping.txt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processorsToClusterMapping</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulationRunner.readMappingFromDisk"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.readMappingFromDisk">[docs]</a>    <span class="k">def</span> <span class="nf">readMappingFromDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epochDir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Read the processorsToClusterMapping from disk</span>

<span class="sd">            :param epochDir: Name of the folder where to write the</span>
<span class="sd">                processorsToClusterMapping</span>
<span class="sd">            :type epochDir: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processorsToClusterMapping</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">readProcessorMappingFromDisk</span><span class="p">(</span><span class="n">epochDir</span><span class="p">,</span> <span class="s2">&quot;processorMapping.txt&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulationRunner.setZeroMapping"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.setZeroMapping">[docs]</a>    <span class="k">def</span> <span class="nf">setZeroMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set the processorsToClusterMapping to zero</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processorsToClusterMapping</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">)]</span></div>

<div class="viewcode-block" id="SimulationRunner.createMultipleComplexesFilenames"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.createMultipleComplexesFilenames">[docs]</a>    <span class="k">def</span> <span class="nf">createMultipleComplexesFilenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numberOfSnapshots</span><span class="p">,</span> <span class="n">tmpInitialStructuresTemplate</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">equilibration</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the string to substitute the complexes in the PELE control file</span>

<span class="sd">            :param numberOfSnapshots: Number of complexes to write</span>
<span class="sd">            :type numberOfSnapshots: int</span>
<span class="sd">            :param tmpInitialStructuresTemplate: Template with the name of the initial strutctures</span>
<span class="sd">            :type tmpInitialStructuresTemplate: str</span>
<span class="sd">            :param iteration: Epoch number</span>
<span class="sd">            :type iteration: int</span>
<span class="sd">            :param equilibration: Flag to mark wether the complexes are part of an</span>
<span class="sd">                equilibration run</span>
<span class="sd">            :type equilibration: bool</span>

<span class="sd">            :returns: str -- jsonString to be substituted in PELE control file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SimulationRunner.prepareControlFile"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.prepareControlFile">[docs]</a>    <span class="k">def</span> <span class="nf">prepareControlFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">peleControlFileDictionary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Substitute the parameters in the PELE control file specified with the</span>
<span class="sd">            provided in the control file</span>

<span class="sd">            :param epoch: Epoch number</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">            :param outputPathConstants: Object that has as attributes constant related to the outputPath that will be used to create the working control file</span>
<span class="sd">            :type outputPathConstants: :py:class:`.OutputPathConstants`</span>
<span class="sd">            :param peleControlFileDictionary: Dictonary containing the values of the parameters to substitute in the control file</span>
<span class="sd">            :type peleControlFileDictionary: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputDir</span> <span class="o">=</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">epochOutputPathTempletized</span> <span class="o">%</span> <span class="n">epoch</span>
        <span class="n">peleControlFileDictionary</span><span class="p">[</span><span class="s2">&quot;OUTPUT_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputDir</span>
        <span class="n">peleControlFileDictionary</span><span class="p">[</span><span class="s2">&quot;SEED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="n">epoch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peleControlFileDictionary</span><span class="p">[</span><span class="s2">&quot;BOX_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxRadius</span>
            <span class="n">peleControlFileDictionary</span><span class="p">[</span><span class="s2">&quot;BOX_CENTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makeWorkingControlFile</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpControlFilename</span> <span class="o">%</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">peleControlFileDictionary</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulationRunner.unifyReportNames"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.unifyReportNames">[docs]</a>    <span class="k">def</span> <span class="nf">unifyReportNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spawningReportName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Ensure that the reportName in the simulation parameters is the same</span>
<span class="sd">            as the one provided in the spawning parameters</span>

<span class="sd">            :param spawningReportName: Name of the report file provided in the spawning parameters</span>
<span class="sd">            :type spawningReportName: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spawningReportName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">baseReportName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">reportName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">baseReportName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">spawningReportName</span><span class="p">:</span>
            <span class="n">baseReportName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spawningReportName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">reportName</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">baseReportName</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimulationRunner.processTrajectories"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.SimulationRunner.processTrajectories">[docs]</a>    <span class="k">def</span> <span class="nf">processTrajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Post-process the simulation trajectories, i.e. superpose to initial frame</span>

<span class="sd">            :param output_path: Path that contains the trajectories</span>
<span class="sd">            :type output_path: str</span>
<span class="sd">            :param topology: Topology object for the simulation</span>
<span class="sd">            :type topology: :py:class:`.Topology`</span>
<span class="sd">            :param epoch: Current epoch of the simulation</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="PeleSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation">[docs]</a><span class="k">class</span> <span class="nc">PeleSimulation</span><span class="p">(</span><span class="n">SimulationRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">SimulationRunner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">SIMULATION_TYPE</span><span class="o">.</span><span class="n">PELE</span>

<div class="viewcode-block" id="PeleSimulation.getClusteringInfo"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.getClusteringInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getClusteringInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return information relevant for MSMClustering</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">peleSteps</span></div>

<div class="viewcode-block" id="PeleSimulation.createSymbolicLinks"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.createSymbolicLinks">[docs]</a>    <span class="k">def</span> <span class="nf">createSymbolicLinks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create symbolic links to Data and Documents folder if they don&#39;t exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ln -s &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">dataFolder</span> <span class="o">+</span> <span class="s2">&quot; Data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="s2">&quot;Documents&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ln -s &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">documentsFolder</span> <span class="o">+</span> <span class="s2">&quot; Documents&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeleSimulation.getWorkingProcessors"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.getWorkingProcessors">[docs]</a>    <span class="k">def</span> <span class="nf">getWorkingProcessors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the number of working processors, i.e. number of trajectories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span> <span class="o">-</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="PeleSimulation.getNextIterationBox"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.getNextIterationBox">[docs]</a>    <span class="k">def</span> <span class="nf">getNextIterationBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputFolder</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">topologies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Select the box for the next epoch, currently selecting the COM of</span>
<span class="sd">            the cluster with max SASA</span>

<span class="sd">            :param outputFolder: Folder to the trajectories</span>
<span class="sd">            :type outputFolder: str</span>
<span class="sd">            :param resname: Residue name of the ligand in the system pdb</span>
<span class="sd">            :type resname: str</span>
<span class="sd">            :param reschain: Chain name of the ligand in the system pdb</span>
<span class="sd">            :type reschain: str</span>
<span class="sd">            :param resnum: Residue number of the ligand in the system pdb</span>
<span class="sd">            :type resnum: int</span>
<span class="sd">            :param topologies: Topology object containing the set of topologies needed for the simulation</span>
<span class="sd">            :type topologies: :py:class:`.Topology`</span>
<span class="sd">            :param epoch: Epoch of the trajectories to analyse</span>
<span class="sd">            :type epoch: int</span>

<span class="sd">            :returns str: -- string to be substitued in PELE control file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getMetricsFromReportsInEpoch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">reportName</span><span class="p">,</span> <span class="n">outputFolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">modeMovingBoxBinding</span><span class="p">:</span>
            <span class="n">SASAcluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">metrics</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">columnSASA</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">SASAcluster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">columnSASA</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">SASAforBox</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">SASAforBox</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">SASAcluster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">columnSASA</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">modeMovingBoxUnBinding</span><span class="p">:</span>
            <span class="n">SASAcluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">metrics</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">columnSASA</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="n">SASAcluster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">columnSASA</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">SASAforBox</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">SASAforBox</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">SASAcluster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">columnSASA</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> should be either binding or unbinding, but </span><span class="si">%s</span><span class="s2"> is provided!!!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="p">))</span>
        <span class="c1"># If this lines are reached then a new extreme SASA value was</span>
        <span class="c1"># identified and we proceed to extract the corresponding center of mass</span>
        <span class="n">trajNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">SASAcluster</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">snapshotNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">SASAcluster</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajectoryName</span> <span class="o">%</span> <span class="n">trajNum</span><span class="p">))[</span><span class="n">snapshotNum</span><span class="p">]</span>
        <span class="n">snapshotPDB</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
        <span class="n">snapshotPDB</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="o">=</span><span class="n">resnum</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topologies</span><span class="o">.</span><span class="n">getTopology</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">trajNum</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapshotPDB</span><span class="o">.</span><span class="n">getCOM</span><span class="p">())</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="PeleSimulation.selectInitialBoxCenter"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.selectInitialBoxCenter">[docs]</a>    <span class="k">def</span> <span class="nf">selectInitialBoxCenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialStructuresAsString</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Select the coordinates of the first box, currently as the center of</span>
<span class="sd">            mass of the first initial structure provided</span>

<span class="sd">            :param initialStructuresAsString: String containing the files of the initial structures</span>
<span class="sd">            :type initialStructuresAsString: str</span>
<span class="sd">            :param resname: Residue name of the ligand in the system pdb</span>
<span class="sd">            :type resname: str</span>
<span class="sd">            :param reschain: Chain name of the ligand in the system pdb</span>
<span class="sd">            :type reschain: str</span>
<span class="sd">            :param resnum: Residue number of the ligand in the system pdb</span>
<span class="sd">            :type resnum: int</span>

<span class="sd">            :returns str: -- string to be substitued in PELE control file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This is a dictionary because it&#39;s prepared to be subtitued in the PELE</span>
        <span class="c1"># control files (i.e. JSON format)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">initialStructuresDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">initialStructuresAsString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">initialStruct</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">initialStructuresDict</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># If a json valid string is not passed, interpret the input string</span>
            <span class="c1"># as a path to a file</span>
            <span class="n">initialStruct</span> <span class="o">=</span> <span class="n">initialStructuresAsString</span>

        <span class="c1"># Note: this lines were not changed when adding support for xtc</span>
        <span class="c1"># trajectories because it was assumed that initial structures would</span>
        <span class="c1"># still be pdbs</span>
        <span class="n">PDBinitial</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
        <span class="n">PDBinitial</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">initialStruct</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="o">=</span><span class="n">resnum</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">PDBinitial</span><span class="o">.</span><span class="n">getCOM</span><span class="p">())</span></div>

<div class="viewcode-block" id="PeleSimulation.generatePELECommand"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.generatePELECommand">[docs]</a>    <span class="k">def</span> <span class="nf">generatePELECommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runningControlFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the command to run PELE using the given parameters</span>

<span class="sd">        :param runningControlFile: Path of the control file to run</span>
<span class="sd">        :type runningControlFile: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">srun</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;srun&quot;</span><span class="p">,</span> <span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">srunParameters</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">runningControlFile</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;mpirun&quot;</span><span class="p">,</span> <span class="s2">&quot;-np&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mpiParameters</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">runningControlFile</span><span class="p">]</span></div>

<div class="viewcode-block" id="PeleSimulation.runEquilibrationPELE"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.runEquilibrationPELE">[docs]</a>    <span class="k">def</span> <span class="nf">runEquilibrationPELE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runningControlFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a short PELE equilibration simulation</span>

<span class="sd">        :param runningControlFile: Path of the control file to run</span>
<span class="sd">        :type runningControlFile: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createSymbolicLinks</span><span class="p">()</span>
        <span class="n">toRun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatePELECommand</span><span class="p">(</span><span class="n">runningControlFile</span><span class="p">)</span>

        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toRun</span><span class="p">))</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">toRun</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnspecifiedPELECrashException</span><span class="p">(</span><span class="s2">&quot;PELE equilibration had an error with exit code </span><span class="si">%d</span><span class="s2">, please check your job output&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>

        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;PELE equilibration took </span><span class="si">%.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">))</span></div>

<div class="viewcode-block" id="PeleSimulation.runSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.runSimulation">[docs]</a>    <span class="k">def</span> <span class="nf">runSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">initialStructuresAsString</span><span class="p">,</span> <span class="n">topologies</span><span class="p">,</span> <span class="n">reportFileName</span><span class="p">,</span> <span class="n">processManager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Run a short PELE simulation</span>

<span class="sd">            :param epoch: number of the epoch</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">            :param outputPathConstants: Contains outputPath-related constants</span>
<span class="sd">            :type outputPathConstants: :py:class:`.OutputPathConstants`</span>
<span class="sd">            :param initialStructures: Name of the initial structures to copy</span>
<span class="sd">            :type initialStructures: str</span>
<span class="sd">            :param topologies: Topology object containing the set of topologies needed for the simulation</span>
<span class="sd">            :type topologies: :py:class:`.Topology`</span>
<span class="sd">            :param reportFileName: Name of the report file</span>
<span class="sd">            :type reportFileName: str</span>
<span class="sd">            :param processManager: Object to synchronize the possibly multiple processes</span>
<span class="sd">            :type processManager: :py:class:`.ProcessesManager`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trajName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajectoryName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">ControlFileDictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;COMPLEXES&quot;</span><span class="p">:</span> <span class="n">initialStructuresAsString</span><span class="p">,</span>
                                 <span class="s2">&quot;PELE_STEPS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">peleSteps</span><span class="p">,</span>
                                 <span class="s2">&quot;BOX_RADIUS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxRadius</span><span class="p">,</span>
                                 <span class="s2">&quot;REPORT_NAME&quot;</span><span class="p">:</span> <span class="n">reportFileName</span><span class="p">,</span>
                                 <span class="s2">&quot;TRAJECTORY_NAME&quot;</span><span class="p">:</span> <span class="n">trajName</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepareControlFile</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">ControlFileDictionary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createSymbolicLinks</span><span class="p">()</span>
        <span class="n">runningControlFile</span> <span class="o">=</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpControlFilename</span> <span class="o">%</span> <span class="n">epoch</span>
        <span class="n">toRun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatePELECommand</span><span class="p">(</span><span class="n">runningControlFile</span><span class="p">)</span>

        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toRun</span><span class="p">))</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">toRun</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnspecifiedPELECrashException</span><span class="p">(</span><span class="s2">&quot;PELE had an error with exit code </span><span class="si">%d</span><span class="s2">, please check your job output&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;Simulation has reached the established time limit, exiting now!!&quot;</span><span class="p">)</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">toRun</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
                <span class="c1"># this should catch in theory negative numbers, but PELE signals</span>
                <span class="c1"># seem to be positive for some reason</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnspecifiedPELECrashException</span><span class="p">(</span><span class="s2">&quot;PELE had an error with exit code </span><span class="si">%d</span><span class="s2">, please check your job output&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>

        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;PELE took </span><span class="si">%.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">))</span></div>

<div class="viewcode-block" id="PeleSimulation.getEquilibrationControlFile"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.getEquilibrationControlFile">[docs]</a>    <span class="k">def</span> <span class="nf">getEquilibrationControlFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peleControlFileDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Filter unnecessary parameters and return a minimal PELE control</span>
<span class="sd">            file for equilibration runs</span>

<span class="sd">            :param peleControlFileDict: Dictionary with pele control file options</span>
<span class="sd">            :type peleControlFileDict: dict</span>

<span class="sd">            :returns: dict -- Dictionary with pele control file options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove dynamical changes in control file</span>
        <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;PeleTasks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;exitConditions&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;PeleTasks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parametersChanges&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;Perturbation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># if the PELE control file contains no Perturbation block we do not</span>
            <span class="c1"># need to change anything else</span>
            <span class="k">return</span> <span class="n">peleControlFileDict</span>

        <span class="c1"># Set small rotations and translations</span>
        <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Perturbation&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;translationRange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationTranslationRange</span>
        <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Perturbation&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;rotationScalingFactor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationRotationRange</span>
        <span class="k">if</span> <span class="s2">&quot;Box&quot;</span> <span class="ow">in</span> <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Perturbation&quot;</span><span class="p">]:</span>
            <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Perturbation&quot;</span><span class="p">][</span><span class="s2">&quot;Box&quot;</span><span class="p">][</span><span class="s2">&quot;fixedCenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$BOX_CENTER&quot;</span>
            <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Perturbation&quot;</span><span class="p">][</span><span class="s2">&quot;Box&quot;</span><span class="p">][</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$BOX_RADIUS&quot;</span>
        <span class="c1"># Ensure random tags exists in metrics</span>
        <span class="n">metricsBlock</span> <span class="o">=</span> <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;PeleTasks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span>
        <span class="n">nMetrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metricsBlock</span><span class="p">)</span>
        <span class="n">randomIndexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nMetrics</span><span class="p">)</span> <span class="k">if</span> <span class="n">metricsBlock</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">])</span>
        <span class="c1"># Delete random numbers from metrics</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">randomIndexes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">metricsBlock</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">nMetrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metricsBlock</span><span class="p">)</span>
        <span class="c1"># Add new random number to metrics</span>
        <span class="n">metricsBlock</span><span class="o">.</span><span class="n">extend</span><span class="p">([{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;rand&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;random&#39;</span><span class="p">}])</span>
        <span class="c1"># Add equilibration dynamical changes</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;doThesechanges&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Perturbation::parameters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rotationScalingFactor&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;ifAnyIsTrue&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;rand &gt;= .5&quot;</span><span class="p">],</span>
            <span class="s2">&quot;otherwise&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Perturbation::parameters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rotationScalingFactor&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">}</span>
            <span class="p">}}</span>
        <span class="n">peleControlFileDict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;PeleTasks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;parametersChanges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">changes</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">peleControlFileDict</span></div>

<div class="viewcode-block" id="PeleSimulation.getMetricColumns"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.getMetricColumns">[docs]</a>    <span class="k">def</span> <span class="nf">getMetricColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">JSONdict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract the column of a similarity distance (RMSD or distance) from the pele control file</span>

<span class="sd">            :param JSONdict: Dictionary containing a parsed PELE control file</span>
<span class="sd">            :type JSONdict: dict</span>

<span class="sd">            :returns: int -- Column index of the similarity metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hasRMSD</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">RMSDCol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">distanceCol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hasDistance</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metricBlock</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">JSONdict</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;PeleTasks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;metrics&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="s1">&#39;rmsd&#39;</span> <span class="ow">in</span> <span class="n">metricBlock</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">hasRMSD</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">RMSDCol</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="s1">&#39;distance&#39;</span> <span class="ow">in</span> <span class="n">metricBlock</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">hasDistance</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">distanceCol</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">hasRMSD</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RMSDCol</span>
        <span class="k">elif</span> <span class="n">hasDistance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">distanceCol</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PeleSimulation.calculateEquilibrationLength"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.calculateEquilibrationLength">[docs]</a>    <span class="k">def</span> <span class="nf">calculateEquilibrationLength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the number of steps for the equilibration lenght accoding</span>
<span class="sd">            to the available processors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Total steps is an approximate number of total steps to produce</span>
        <span class="n">totalSteps</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="c1"># Take at least 5 steps</span>
        <span class="n">stepsPerProc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">totalSteps</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c1"># but no more than 50</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">stepsPerProc</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeleSimulation.equilibrate"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.equilibrate">[docs]</a>    <span class="k">def</span> <span class="nf">equilibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialStructures</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">reportFilename</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">processManager</span><span class="p">,</span> <span class="n">topologies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Run short simulation to equilibrate the system. It will run one</span>
<span class="sd">            such simulation for every initial structure and select appropiate</span>
<span class="sd">            structures to start the simulation</span>

<span class="sd">            :param initialStructures: Name of the initial structures to copy</span>
<span class="sd">            :type initialStructures: list of str</span>
<span class="sd">            :param outputPathConstants: Contains outputPath-related constants</span>
<span class="sd">            :type outputPathConstants: :py:class:`.OutputPathConstants`</span>
<span class="sd">            :param reportBaseFilename: Name of the file that contains the metrics of the snapshots to cluster</span>
<span class="sd">            :type reportBaseFilename: str</span>
<span class="sd">            :param outputPath: Path where trajectories are found</span>
<span class="sd">            :type outputPath: str</span>
<span class="sd">            :param resname: Residue name of the ligand in the system pdb</span>
<span class="sd">            :type resname: str</span>
<span class="sd">            :param reschain: Chain name of the ligand in the system pdb</span>
<span class="sd">            :type reschain: str</span>
<span class="sd">            :param resnum: Residue number of the ligand in the system pdb</span>
<span class="sd">            :type resnum: int</span>
<span class="sd">            :param processManager: Object to synchronize the possibly multiple processes</span>
<span class="sd">            :type processManager: :py:class:`.ProcessesManager`</span>
<span class="sd">            :param topologies: Topology object containing the set of topologies needed for the simulation</span>
<span class="sd">            :type topologies: :py:class:`.Topology`</span>

<span class="sd">            :returns: list --  List with initial structures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check that we have some way of identifyin the ligand</span>
        <span class="n">ligandInputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">resname</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">resnum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reschain</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">ligandInputs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">RequiredParameterMissingException</span><span class="p">(</span><span class="s2">&quot;Ligand information not specified in clustering block!!!&quot;</span><span class="p">)</span>
        <span class="n">newInitialStructures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newStructure</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationLength</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateEquilibrationLength</span><span class="p">()</span>
        <span class="n">trajName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajectoryName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">equilibrationPeleDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PELE_STEPS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationLength</span><span class="p">,</span> <span class="s2">&quot;SEED&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">seed</span><span class="p">}</span>
        <span class="n">peleControlFileDict</span><span class="p">,</span> <span class="n">templateNames</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getPELEControlFileDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">templetizedControlFile</span><span class="p">)</span>
        <span class="n">peleControlFileDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEquilibrationControlFile</span><span class="p">(</span><span class="n">peleControlFileDict</span><span class="p">)</span>
        <span class="n">similarityColumn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMetricColumns</span><span class="p">(</span><span class="n">peleControlFileDict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">):</span>
            <span class="n">equilibrationOutput</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="s2">&quot;equilibration_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">equilibrationControlFile</span> <span class="o">=</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpControlFilenameEqulibration</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">utilities</span><span class="o">.</span><span class="n">makeFolder</span><span class="p">(</span><span class="n">equilibrationOutput</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpInitialStructuresEquilibrationTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">initialStructureString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createMultipleComplexesFilenames</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpInitialStructuresEquilibrationTemplate</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">equilibration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">equilibrationPeleDict</span><span class="p">[</span><span class="s2">&quot;OUTPUT_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">equilibrationOutput</span>
            <span class="n">equilibrationPeleDict</span><span class="p">[</span><span class="s2">&quot;COMPLEXES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialStructureString</span>
            <span class="n">equilibrationPeleDict</span><span class="p">[</span><span class="s2">&quot;BOX_CENTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectInitialBoxCenter</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">)</span>
            <span class="n">equilibrationPeleDict</span><span class="p">[</span><span class="s2">&quot;BOX_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationBoxRadius</span>
            <span class="n">equilibrationPeleDict</span><span class="p">[</span><span class="s2">&quot;REPORT_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reportFilename</span>
            <span class="n">equilibrationPeleDict</span><span class="p">[</span><span class="s2">&quot;TRAJECTORY_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trajName</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BOX_CENTER&quot;</span><span class="p">,</span> <span class="s2">&quot;BOX_RADIUS&quot;</span><span class="p">]:</span>
                <span class="c1"># If the template PELE control file is not templetized with the</span>
                <span class="c1"># box information, include it manually</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">templateNames</span><span class="p">:</span>
                    <span class="n">templateNames</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&quot;$</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;Running equilibration for initial structure number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">peleControlString</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">peleControlFileDict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">templateNames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Remove double quote around template keys, so that PELE</span>
                <span class="c1"># understands the options</span>
                <span class="n">peleControlString</span> <span class="o">=</span> <span class="n">peleControlString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">makeWorkingControlFile</span><span class="p">(</span><span class="n">equilibrationControlFile</span><span class="p">,</span> <span class="n">equilibrationPeleDict</span><span class="p">,</span> <span class="n">peleControlString</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runEquilibrationPELE</span><span class="p">(</span><span class="n">equilibrationControlFile</span><span class="p">)</span>
            <span class="c1"># Extract report, trajnames, metrics columns from pele control file</span>
            <span class="n">reportNames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">equilibrationOutput</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">reportName</span><span class="p">)</span>
            <span class="n">trajNames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">equilibrationOutput</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajectoryName</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationMode</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationLastSnapshot</span><span class="p">:</span>
                <span class="n">newStructure</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectEquilibrationLastSnapshot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">,</span> <span class="n">trajNames</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topologies</span><span class="o">.</span><span class="n">topologies</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationMode</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationSelect</span><span class="p">:</span>
                <span class="n">newStructure</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectEquilibratedStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">,</span> <span class="n">similarityColumn</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">trajNames</span><span class="p">,</span> <span class="n">reportNames</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topologies</span><span class="o">.</span><span class="n">topologies</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">equilibrationMode</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationCluster</span><span class="p">:</span>
                <span class="n">newStructure</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusterEquilibrationStructures</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">trajNames</span><span class="p">,</span> <span class="n">reportNames</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topologies</span><span class="o">.</span><span class="n">topologies</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newStructure</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWorkingProcessors</span><span class="p">():</span>
            <span class="c1"># if for some reason the number of selected structures exceeds</span>
            <span class="c1"># the number of available processors, randomly sample the initial</span>
            <span class="c1"># structures</span>
            <span class="n">newStructure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">newStructure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWorkingProcessors</span><span class="p">(),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">struct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newStructure</span><span class="p">):</span>
            <span class="n">newStructurePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">equilibrationOutput</span><span class="p">,</span> <span class="s1">&#39;equilibration_struc_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.pdb&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">newStructurePath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
            <span class="n">newInitialStructures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newStructurePath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newInitialStructures</span></div>

<div class="viewcode-block" id="PeleSimulation.clusterEquilibrationStructures"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.clusterEquilibrationStructures">[docs]</a>    <span class="k">def</span> <span class="nf">clusterEquilibrationStructures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">trajWildcard</span><span class="p">,</span> <span class="n">reportWildcard</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Cluster the equilibration run</span>

<span class="sd">            :param resname: Residue name of the ligand in the system pdb</span>
<span class="sd">            :type resname: str</span>
<span class="sd">            :param reschain: Chain name of the ligand in the system pdb</span>
<span class="sd">            :type reschain: str</span>
<span class="sd">            :param resnum: Residue number of the ligand in the system pdb</span>
<span class="sd">            :type resnum: int</span>
<span class="sd">            :param trajWildcard: Templetized path to trajectory files&quot;</span>
<span class="sd">            :type trajWildcard: str</span>
<span class="sd">            :param reportWildcard: Templetized path to report files&quot;</span>
<span class="sd">            :type reportWildcard: str</span>
<span class="sd">            :param topology: Topology for non-pdb trajectories</span>
<span class="sd">            :type topology: list</span>

<span class="sd">            :returns: list -- List with the pdb snapshots of the representatives structures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SKLEARN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnsatisfiedDependencyException</span><span class="p">(</span><span class="s2">&quot;No installation of scikit-learn found. Please, install scikit-learn or select a different equilibrationMode.&quot;</span><span class="p">)</span>
        <span class="n">energyColumn</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="c1"># detect number of trajectories available</span>
        <span class="n">nTrajs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">getReportList</span><span class="p">(</span><span class="n">trajWildcard</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nTrajs</span><span class="p">):</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">loadtxtfile</span><span class="p">(</span><span class="n">reportWildcard</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">snapshots</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajWildcard</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nSnap</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">)):</span>
                <span class="n">conformation</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
                <span class="n">conformation</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="o">=</span><span class="n">resnum</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span>
                <span class="n">com</span> <span class="o">=</span> <span class="n">conformation</span><span class="o">.</span><span class="n">getCOM</span><span class="p">()</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="n">energyColumn</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">nSnap</span><span class="p">]</span><span class="o">+</span><span class="n">com</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnspecifiedPELECrashException</span><span class="p">(</span><span class="s2">&quot;Some error happened with PELE and no trajectories were written!!&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
        <span class="n">nPoints</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">nPoints</span><span class="p">]</span>
        <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:])</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;Clustered equilibration output into </span><span class="si">%d</span><span class="s2"> clusters!&quot;</span> <span class="o">%</span> <span class="n">n_clusters</span><span class="p">)</span>
        <span class="n">clustersInfo</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;minDist&quot;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">conf</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">-</span><span class="n">conf</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">clustersInfo</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="s2">&quot;minDist&quot;</span><span class="p">]:</span>
                <span class="n">clustersInfo</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="s2">&quot;minDist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="n">clustersInfo</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">initialStructures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">clustersInfo</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If a cluster has no structure assigned, skip it</span>
                <span class="k">continue</span>
            <span class="n">traj</span><span class="p">,</span> <span class="n">snap</span> <span class="o">=</span> <span class="n">clustersInfo</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajWildcard</span> <span class="o">%</span> <span class="n">traj</span><span class="p">)[</span><span class="n">snap</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">conf</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_mdtraj_object_PDBstring</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>
            <span class="n">initialStructures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">initialStructures</span></div>

<div class="viewcode-block" id="PeleSimulation.selectEquilibrationLastSnapshot"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.selectEquilibrationLastSnapshot">[docs]</a>    <span class="k">def</span> <span class="nf">selectEquilibrationLastSnapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nTrajs</span><span class="p">,</span> <span class="n">trajWildcard</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Select the last snapshot of each trajectory as a  representative</span>
<span class="sd">            initial structure from the equilibration run</span>

<span class="sd">            :param nTrajs: Number of trajectories</span>
<span class="sd">            :type nTrajs: int</span>
<span class="sd">            :param trajWildcard: Templetized path to trajectory files&quot;</span>
<span class="sd">            :type trajWildcard: str</span>
<span class="sd">            :param topology: Topology for non-pdb trajectories</span>
<span class="sd">            :type topology: list</span>

<span class="sd">            :returns: list -- List with the pdb snapshots of the representatives structures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initialStructures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nTrajs</span><span class="p">):</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajWildcard</span> <span class="o">%</span> <span class="n">ij</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">conf</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_mdtraj_object_PDBstring</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>
            <span class="n">initialStructures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">initialStructures</span></div>

<div class="viewcode-block" id="PeleSimulation.selectEquilibratedStructure"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.selectEquilibratedStructure">[docs]</a>    <span class="k">def</span> <span class="nf">selectEquilibratedStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nTrajs</span><span class="p">,</span> <span class="n">similarityColumn</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">trajWildcard</span><span class="p">,</span> <span class="n">reportWildcard</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Select a representative initial structure from the equilibration</span>
<span class="sd">            run</span>

<span class="sd">            :param nTrajs: Number of trajectories</span>
<span class="sd">            :type nTrajs: int</span>
<span class="sd">            :param similarityColumn: Column number of the similarity metric</span>
<span class="sd">                (RMSD or distance)</span>
<span class="sd">            :type similarityColumn: int</span>
<span class="sd">            :param resname: Residue name of the ligand in the system pdb</span>
<span class="sd">            :type resname: str</span>
<span class="sd">            :param reschain: Chain name of the ligand in the system pdb</span>
<span class="sd">            :type reschain: str</span>
<span class="sd">            :param resnum: Residue number of the ligand in the system pdb</span>
<span class="sd">            :type resnum: int</span>
<span class="sd">            :param trajWildcard: Templetized path to trajectory files&quot;</span>
<span class="sd">            :type trajWildcard: str</span>
<span class="sd">            :param reportWildcard: Templetized path to report files&quot;</span>
<span class="sd">            :type reportWildcard: str</span>
<span class="sd">            :param topology: Topology for non-pdb trajectories</span>
<span class="sd">            :type topology: list</span>

<span class="sd">            :returns: list -- List with the pdb snapshots of the representatives structures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">energyColumn</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rowIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">similarityColumn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">RMSDCalc</span> <span class="o">=</span> <span class="n">RMSDCalculator</span><span class="o">.</span><span class="n">RMSDCalculator</span><span class="p">()</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">energyColumn</span><span class="p">,</span> <span class="n">similarityColumn</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nTrajs</span><span class="p">):</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowIndex</span><span class="p">)</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">loadtxtfile</span><span class="p">(</span><span class="n">reportWildcard</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">similarityColumn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">snapshots</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajWildcard</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">report_values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">initial</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">resname</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="o">=</span><span class="n">resnum</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span>
                    <span class="n">report_values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">report</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">energyColumn</span><span class="p">]])</span>
                    <span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">snap</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">snapshots</span><span class="p">):</span>
                    <span class="n">pdbConformation</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
                    <span class="n">pdbConformation</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="o">=</span><span class="n">resnum</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span>
                    <span class="n">report_values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">RMSDCalc</span><span class="o">.</span><span class="n">computeRMSD</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">pdbConformation</span><span class="p">),</span> <span class="n">report</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">energyColumn</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">report_values</span> <span class="o">=</span> <span class="n">report</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">report_values</span><span class="p">)</span>
            <span class="n">rowIndex</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">report_values</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">similarityColumn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">energyColumn</span> <span class="o">&gt;</span> <span class="n">similarityColumn</span><span class="p">:</span>
            <span class="n">similarityColumn</span><span class="p">,</span> <span class="n">energyColumn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energyColumn</span><span class="p">,</span> <span class="n">similarityColumn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">maxEnergy</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">energyColumn</span><span class="p">]</span>
        <span class="c1"># Substract the max value so all values will be negative (avoid sign problems)</span>
        <span class="n">values</span><span class="p">[:,</span> <span class="n">energyColumn</span><span class="p">]</span> <span class="o">-=</span> <span class="n">maxEnergy</span>
        <span class="n">minEnergy</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">energyColumn</span><span class="p">]</span>
        <span class="c1"># Normalize to the minimum value</span>
        <span class="n">values</span><span class="p">[:,</span> <span class="n">energyColumn</span><span class="p">]</span> <span class="o">/=</span> <span class="n">minEnergy</span>
        <span class="n">freq</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">values</span><span class="p">[:,</span> <span class="n">similarityColumn</span><span class="p">])</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">)))</span>
        <span class="c1"># Get center of the bins</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="n">similarityColumn</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">similarityColumn</span><span class="p">]</span> <span class="o">-</span> <span class="n">centers</span><span class="p">))]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indexSelected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
        <span class="c1"># Get trajectory and snapshot number from the index selected</span>
        <span class="n">trajNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">indexSelected</span><span class="p">:</span>
                <span class="n">trajNum</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">indexSelected</span> <span class="o">&lt;</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">trajNum</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>
        <span class="n">snapshotNum</span> <span class="o">=</span> <span class="n">indexSelected</span><span class="o">-</span><span class="n">indices</span><span class="p">[</span><span class="n">trajNum</span><span class="p">]</span>
        <span class="c1"># trajectories are 1-indexed</span>
        <span class="n">trajNum</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># return as list for compatibility with selectEquilibrationLastSnapshot</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajWildcard</span> <span class="o">%</span> <span class="n">trajNum</span><span class="p">)[</span><span class="n">snapshotNum</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_mdtraj_object_PDBstring</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">conf</span><span class="p">]</span></div>

<div class="viewcode-block" id="PeleSimulation.createMultipleComplexesFilenames"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.PeleSimulation.createMultipleComplexesFilenames">[docs]</a>    <span class="k">def</span> <span class="nf">createMultipleComplexesFilenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numberOfSnapshots</span><span class="p">,</span> <span class="n">tmpInitialStructuresTemplate</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">equilibration</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the string to substitute the complexes in the PELE control file</span>

<span class="sd">            :param numberOfSnapshots: Number of complexes to write</span>
<span class="sd">            :type numberOfSnapshots: int</span>
<span class="sd">            :param tmpInitialStructuresTemplate: Template with the name of the initial strutctures</span>
<span class="sd">            :type tmpInitialStructuresTemplate: str</span>
<span class="sd">            :param iteration: Epoch number</span>
<span class="sd">            :type iteration: int</span>
<span class="sd">            :param equilibration: Flag to mark whether the complexes are part of an</span>
<span class="sd">                equilibration run</span>
<span class="sd">            :type equilibration: bool</span>

<span class="sd">            :returns: str -- jsonString to be substituted in PELE control file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jsonString</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfSnapshots</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">equilibration</span><span class="p">:</span>
                <span class="n">jsonString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">inputFileTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpInitialStructuresTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jsonString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">inputFileTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpInitialStructuresTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">equilibration</span><span class="p">:</span>
            <span class="n">jsonString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">inputFileTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpInitialStructuresTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jsonString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">inputFileTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpInitialStructuresTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">numberOfSnapshots</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jsonString</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MDSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation">[docs]</a><span class="k">class</span> <span class="nc">MDSimulation</span><span class="p">(</span><span class="n">SimulationRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">SimulationRunner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">SIMULATION_TYPE</span><span class="o">.</span><span class="n">MD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antechamberTemplate</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">antechamberTemplate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parmchkTemplate</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">parmchk2Template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tleapTemplate</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">tleapTemplate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prmtopFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">OPENMM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnsatisfiedDependencyException</span><span class="p">(</span><span class="s2">&quot;No installation of OpenMM found. Please, install OpenMM to run MD simulations.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkAmbertools</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnsatisfiedDependencyException</span><span class="p">(</span><span class="s2">&quot;No installation of AmberTools found. Please, install AmberTools to run MD simulations.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MDSimulation.checkAmbertools"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.checkAmbertools">[docs]</a>    <span class="k">def</span> <span class="nf">checkAmbertools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;antechamber&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># If antechamber is not defined (i.e. ambertools not available)</span>
            <span class="c1"># popen raises an OSError</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MDSimulation.getWorkingProcessors"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.getWorkingProcessors">[docs]</a>    <span class="k">def</span> <span class="nf">getWorkingProcessors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the number of working processors, i.e. number of trajectories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span></div>

<div class="viewcode-block" id="MDSimulation.processTrajectories"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.processTrajectories">[docs]</a>    <span class="k">def</span> <span class="nf">processTrajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Post-process the simulation trajectories, i.e. superpose to initial frame</span>

<span class="sd">            :param output_path: Path that contains the trajectories</span>
<span class="sd">            :type output_path: str</span>
<span class="sd">            :param topology: Topology object for the simulation</span>
<span class="sd">            :type topology: :py:class:`.Topology`</span>
<span class="sd">            :param epoch: Current epoch of the simulation</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing trajectories for epoch&quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="n">trajectory_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">trajectoryTemplate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">format</span><span class="p">))</span>
        <span class="n">trajectory_files</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">topology</span><span class="o">.</span><span class="n">getTopologyFile</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getTrajNum</span><span class="p">(</span><span class="n">traj</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">traj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectory_files</span><span class="p">)]</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">processTraj</span><span class="p">,</span> <span class="n">trajectory_files</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="MDSimulation.getResname"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.getResname">[docs]</a>    <span class="k">def</span> <span class="nf">getResname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the value of the ligand name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># arbitrarely return the first ligand name</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="MDSimulation.equilibrate"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.equilibrate">[docs]</a>    <span class="k">def</span> <span class="nf">equilibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialStructures</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">reportFilename</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">,</span> <span class="n">resnames</span><span class="p">,</span> <span class="n">reschain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">processManager</span><span class="p">,</span> <span class="n">topologies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Run short simulation to equilibrate the system. It will run one</span>
<span class="sd">            such simulation for every initial structure</span>
<span class="sd">            (some of the arguments are not needed, such as (reportFilename, outputPath and topology) but they are kept</span>
<span class="sd">            to follow the same structure has the Super class definition)</span>

<span class="sd">            :param initialStructures: Name of the initial structures to copy</span>
<span class="sd">            :type initialStructures: list of str</span>
<span class="sd">            :param outputPathConstants: Contains outputPath-related constants</span>
<span class="sd">            :type outputPathConstants: :py:class:`.OutputPathConstants`</span>
<span class="sd">            :param reportBaseFilename: Name of the file that contains the metrics of the snapshots to cluster</span>
<span class="sd">            :type reportBaseFilename: str</span>
<span class="sd">            :param outputPath: Path where trajectories are found</span>
<span class="sd">            :type outputPath: str</span>
<span class="sd">            :param resnames: Residue name of the ligands in the system pdb</span>
<span class="sd">            :type resnames: list</span>
<span class="sd">            :param reschain: Chain name of the ligand in the system pdb</span>
<span class="sd">            :type reschain: str</span>
<span class="sd">            :param resnum: Residue number of the ligand in the system pdb</span>
<span class="sd">            :type resnum: int</span>
<span class="sd">            :param processManager: Object to synchronize the possibly multiple processes</span>
<span class="sd">            :type processManager: :py:class:`.ProcessesManager`</span>
<span class="sd">            :param topology: Topology object</span>
<span class="sd">            :type topology: :py:class:</span>

<span class="sd">            :returns: list -- List with initial structures</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">COFACTOR_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AdaptivePELE</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">__path__</span><span class="p">),</span> <span class="s2">&quot;MDtemplates/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="o">*</span><span class="n">processManager</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">):</span>
            <span class="c1"># Only need to launch as many simulations as initial structures</span>
            <span class="c1"># synchronize the replicas that will not run equilibration with the</span>
            <span class="c1"># replicas that will do, i.e with the synchronize in the middle of</span>
            <span class="c1"># this method</span>
            <span class="n">processManager</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">initialStructures</span> <span class="o">=</span> <span class="n">processManager</span><span class="o">.</span><span class="n">getStructureListPerReplica</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">)</span>
        <span class="n">solvatedStrcutures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">equilibrationFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">equilibrationOutput</span> <span class="o">=</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">equilibrationDir</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">makeFolder</span><span class="p">(</span><span class="n">equilibrationOutput</span><span class="p">)</span>
        <span class="c1"># AmberTools generates intermediate files in the current directory, change to the tmp folder</span>
        <span class="n">workingdirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpFolder</span><span class="p">)</span>
        <span class="n">temporalFolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">Tleapdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;LIGANDS&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;DUM&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">charge</span><span class="p">,</span> <span class="n">resname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandCharge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandName</span><span class="p">):</span>
                <span class="n">ligandPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractLigand</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">resname</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">processManager</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">ligandmol2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.mol2&quot;</span> <span class="o">%</span> <span class="n">resname</span>
                <span class="n">ligandfrcmod</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.frcmod&quot;</span> <span class="o">%</span> <span class="n">resname</span>
                <span class="n">antechamberDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;LIGAND&quot;</span><span class="p">:</span> <span class="n">ligandPDB</span><span class="p">,</span> <span class="s2">&quot;OUTPUT&quot;</span><span class="p">:</span> <span class="n">ligandmol2</span><span class="p">,</span> <span class="s2">&quot;CHARGE&quot;</span><span class="p">:</span> <span class="n">charge</span><span class="p">}</span>
                <span class="n">parmchkDict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MOL2&quot;</span><span class="p">:</span> <span class="n">ligandmol2</span><span class="p">,</span> <span class="s2">&quot;OUTPUT&quot;</span><span class="p">:</span> <span class="n">ligandfrcmod</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">processManager</span><span class="o">.</span><span class="n">isMaster</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span> <span class="ow">and</span> <span class="n">resname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepareLigand</span><span class="p">(</span><span class="n">antechamberDict</span><span class="p">,</span> <span class="n">parmchkDict</span><span class="p">)</span>
                <span class="n">amber_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="c1"># Change the Mol2 and Frcmod path to the new user defined path</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span> <span class="ow">and</span> <span class="n">resname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span><span class="p">):</span>
                        <span class="c1"># As the working directory has changed, eval if the given path is a global or relative one.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No custom parameters found in the given path&quot;</span><span class="p">)</span>
                    <span class="n">ligandmol2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span><span class="p">,</span> <span class="n">ligandmol2</span><span class="p">)</span>
                    <span class="n">ligandfrcmod</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span><span class="p">,</span> <span class="n">ligandfrcmod</span><span class="p">)</span>
                    <span class="n">amber_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">customparamspath</span>
                <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;LIGANDS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = loadmol2 </span><span class="si">{}</span><span class="se">\n</span><span class="s2">loadamberparams </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">ligandmol2</span><span class="p">,</span> <span class="n">ligandfrcmod</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cylinderBases</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">sphere</span><span class="p">:</span>
                <span class="n">prep_template</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_prep</span>
                <span class="n">frcmod_template</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_frcmod</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">cylinder</span><span class="p">:</span>
                <span class="n">prep_template</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_cyl_prep</span>
                <span class="n">frcmod_template</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_cyl_frcmod</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">amber_file_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.prep&quot;</span> <span class="o">%</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_res</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prep_template</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">amber_file_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.frcmod&quot;</span> <span class="o">%</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_res</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frcmod_template</span><span class="p">)</span>

        <span class="n">processManager</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_constraints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_constraints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">initialStructures</span><span class="p">:</span>
            <span class="n">TleapControlFile</span> <span class="o">=</span> <span class="s2">&quot;tleap_equilibration_</span><span class="si">%d</span><span class="s2">.in&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">pdb</span> <span class="o">=</span> <span class="n">PDBLoader</span><span class="o">.</span><span class="n">PDBManager</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandName</span><span class="p">)</span>
            <span class="n">constraints_map</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">preparePDBforMD</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="n">boxCenter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span><span class="p">,</span> <span class="n">cylinderBases</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cylinderBases</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">constraints_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_constraints</span> <span class="o">=</span> <span class="n">updateConstraints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="n">constraints_map</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prev_constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">prev_constraints</span> <span class="o">=</span> <span class="n">new_constraints</span>
                <span class="k">assert</span> <span class="n">new_constraints</span> <span class="o">==</span> <span class="n">prev_constraints</span>
                <span class="n">prev_constraints</span> <span class="o">=</span> <span class="n">new_constraints</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">writeAll</span><span class="p">(</span><span class="n">outputpath</span><span class="o">=</span><span class="n">temporalFolder</span><span class="p">,</span> <span class="n">outputname</span><span class="o">=</span><span class="s2">&quot;initial_</span><span class="si">%d</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">prmtop</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">topologies</span><span class="p">,</span> <span class="s2">&quot;system_</span><span class="si">%d</span><span class="s2">.prmtop&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">inpcrd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">,</span> <span class="n">equilibrationOutput</span><span class="p">,</span> <span class="s2">&quot;system_</span><span class="si">%d</span><span class="s2">.inpcrd&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">finalPDB</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">,</span> <span class="n">equilibrationOutput</span><span class="p">,</span> <span class="s2">&quot;system_</span><span class="si">%d</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;FORCEFIELD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">forcefields</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">forcefield</span><span class="p">]</span>

            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;BOXSIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">compute_water_box</span><span class="p">(</span><span class="n">waterBoxSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">waterBoxSize</span><span class="p">,</span>
                                                         <span class="n">boxCenter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span><span class="p">,</span>
                                                         <span class="n">boxRadius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxRadius</span><span class="p">)</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COMPLEX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;PRMTOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prmtop</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;INPCRD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inpcrd</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;SOLVATED_PDB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalPDB</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;BONDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">getDisulphideBondsforTleapTemplate</span><span class="p">()</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cofactors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cof</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cofactors</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">CofactorTemplateNames</span><span class="o">.</span><span class="n">fadh</span> <span class="o">==</span> <span class="n">cof</span><span class="p">:</span>
                        <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;loadoff </span><span class="si">{}</span><span class="s2">new_</span><span class="si">{}</span><span class="s2">.lib</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COFACTOR_PATH</span><span class="p">,</span> <span class="n">cof</span><span class="p">)</span>
                        <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;loadamberparams </span><span class="si">{}{}</span><span class="s2">.frcfld</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COFACTOR_PATH</span><span class="p">,</span> <span class="n">cof</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">CofactorTemplateNames</span><span class="o">.</span><span class="n">fmn</span> <span class="o">==</span> <span class="n">cof</span><span class="p">:</span>
                        <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;loadoff </span><span class="si">{}{}</span><span class="s2">.off</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COFACTOR_PATH</span><span class="p">,</span> <span class="n">cof</span><span class="p">)</span>
                        <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;loadamberparams </span><span class="si">{}{}</span><span class="s2">.frcfld</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COFACTOR_PATH</span><span class="p">,</span> <span class="n">cof</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">CofactorTemplateNames</span><span class="o">.</span><span class="n">nad</span> <span class="ow">in</span> <span class="n">cof</span><span class="p">:</span>
                        <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;loadamberprep </span><span class="si">{}{}</span><span class="s2">.prep</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COFACTOR_PATH</span><span class="p">,</span> <span class="n">cof</span><span class="p">)</span>
                        <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;COFACTORS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;loadamberparams </span><span class="si">{}{}</span><span class="s2">.frcmod</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COFACTOR_PATH</span><span class="p">,</span> <span class="n">cof</span><span class="p">)</span>
            <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;MODIFIED_RES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">getModifiedResiduesTleapTemplate</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxCenter</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cylinderBases</span><span class="p">:</span>
                <span class="n">Tleapdict</span><span class="p">[</span><span class="s2">&quot;DUM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;loadamberprep </span><span class="si">%s</span><span class="s2">.prep</span><span class="se">\n</span><span class="s2">loadamberparams </span><span class="si">%s</span><span class="s2">.frcmod</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_res</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">AmberTemplates</span><span class="o">.</span><span class="n">DUM_res</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeWorkingControlFile</span><span class="p">(</span><span class="n">TleapControlFile</span><span class="p">,</span> <span class="n">Tleapdict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tleapTemplate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runTleap</span><span class="p">(</span><span class="n">TleapControlFile</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;leap.log&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">,</span> <span class="n">equilibrationOutput</span><span class="p">,</span> <span class="s2">&quot;leap_</span><span class="si">%d</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">solvatedStrcutures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finalPDB</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inpcrd</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Error While running Tleap, check </span><span class="si">%s</span><span class="s2">/leap_</span><span class="si">%d</span><span class="s2">.log for more information.&quot;</span> <span class="o">%</span>
                                        <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">,</span> <span class="n">equilibrationOutput</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prmtopFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prmtop</span><span class="p">)</span>
            <span class="n">equilibrationFiles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prmtop</span><span class="p">,</span> <span class="n">inpcrd</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">new_constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">new_constraints</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">equilibrationFiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">),</span> <span class="s2">&quot;Equilibration files and initial structures don&#39;t match&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">equilibrationFiles</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">,</span> <span class="s2">&quot;Too many equilibration structures per replica&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workingdirectory</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">equilibrationFiles</span><span class="p">))</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;Equilibrating System&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">equilibrationFilePair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equilibrationFiles</span><span class="p">):</span>
            <span class="n">reportName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">equilibrationOutput</span><span class="p">,</span> <span class="s2">&quot;equilibrated_system_</span><span class="si">%d</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">processManager</span><span class="o">.</span><span class="n">id</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">))</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">runEquilibration</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">equilibrationFilePair</span><span class="p">,</span> <span class="n">reportName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># the new initialStructures list contains tuples in the form (i,</span>
        <span class="c1"># structure) where i is the index of structure in the original list</span>
        <span class="n">newInitialStructures</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_workers_output</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;Equilibration took </span><span class="si">%.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">newInitialStructures</span></div>

<div class="viewcode-block" id="MDSimulation.runTleap"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.runTleap">[docs]</a>    <span class="k">def</span> <span class="nf">runTleap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TleapControlFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method that runs the Tleap software form Ambertools</span>

<span class="sd">        :param TleapControlFile: Path to the Tleap.in file</span>
<span class="sd">        :type TleapControlFile: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tleapCommand</span> <span class="o">=</span> <span class="s2">&quot;tleap -f </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TleapControlFile</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System Preparation&quot;</span><span class="p">)</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">tleapCommand</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error Found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnsatisfiedDependencyException</span><span class="p">(</span><span class="s2">&quot;Error Runing Tleap. Please check your installation of Ambertools.&quot;</span><span class="p">)</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System preparation took </span><span class="si">%.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">))</span></div>

<div class="viewcode-block" id="MDSimulation.extractLigand"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.extractLigand">[docs]</a>    <span class="k">def</span> <span class="nf">extractLigand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PDBtoOpen</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">outputpath</span><span class="p">,</span> <span class="n">id_replica</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extracts the ligand from a given PDB</span>

<span class="sd">            :param PDBtoOpen: string with the pdb to prepare</span>
<span class="sd">            :type PDBtoOpen: str</span>
<span class="sd">            :param resname: resname of the ligand to extract</span>
<span class="sd">            :type resname: str</span>
<span class="sd">            :param outputPath: Path where the pdb is written</span>
<span class="sd">            :type outputPath: str</span>
<span class="sd">            :param id_replica: Id of the current replica</span>
<span class="sd">            :type id_replica: int</span>

<span class="sd">            :returns: str -- string with the ligand pdb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">resname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ligandpdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputpath</span><span class="p">,</span> <span class="s2">&quot;raw_ligand_</span><span class="si">%s</span><span class="s2">.pdb&quot;</span> <span class="o">%</span> <span class="n">resname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">id_replica</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ligandpdb</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PDBtoOpen</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HETATM&quot;</span><span class="p">):</span>
                    <span class="n">line_resname</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">resname</span> <span class="o">!=</span> <span class="n">line_resname</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">])</span> <span class="ow">in</span> <span class="n">line_dict</span><span class="p">:</span>
                        <span class="n">line_dict</span><span class="p">[(</span><span class="n">resname</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">])]</span> <span class="o">+=</span> <span class="n">line</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line_dict</span><span class="p">[(</span><span class="n">resname</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">])]</span> <span class="o">=</span> <span class="n">line</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ligandpdb</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pdb_line</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">line_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pdb_line</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ligandpdb</span></div>

<div class="viewcode-block" id="MDSimulation.prepareLigand"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.prepareLigand">[docs]</a>    <span class="k">def</span> <span class="nf">prepareLigand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">antechamberDict</span><span class="p">,</span> <span class="n">parmchkDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs antechamber and parmchk2 to obtain the mol2 and frcmod of the ligand</span>

<span class="sd">        :param antechamberDict: Dictonary containing the parameters to substitute in the antechamber command</span>
<span class="sd">        :type antechamberDict: dict</span>
<span class="sd">        :param parmchkDict: Dictonary containing the parameters to substitute in the parmchk2 command</span>
<span class="sd">        :type parmchkDict: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">antechamberCommand</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antechamberTemplate</span><span class="p">)</span>
        <span class="n">antechamberCommand</span> <span class="o">=</span> <span class="n">antechamberCommand</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">antechamberDict</span><span class="p">)</span>
        <span class="n">parmchkCommand</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parmchkTemplate</span><span class="p">)</span>
        <span class="n">parmchkCommand</span> <span class="o">=</span> <span class="n">parmchkCommand</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">parmchkDict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">antechamberCommand</span><span class="p">)</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">antechamberCommand</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error Found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnsatisfiedDependencyException</span><span class="p">(</span><span class="s2">&quot;Error Runing Antechamber. Please check your installation of Ambertools.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">parmchkCommand</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">parmchkCommand</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error Found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">UnsatisfiedDependencyException</span><span class="p">(</span><span class="s2">&quot;Error Runing Parmchk2. Please check your installation of Ambertools.&quot;</span><span class="p">)</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ligand preparation took </span><span class="si">%.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">))</span></div>

<div class="viewcode-block" id="MDSimulation.runSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.runSimulation">[docs]</a>    <span class="k">def</span> <span class="nf">runSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">initialStructuresAsString</span><span class="p">,</span> <span class="n">topologies</span><span class="p">,</span> <span class="n">reportFileName</span><span class="p">,</span> <span class="n">processManager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Run a MD simulation using OpenMM</span>

<span class="sd">            :param epoch: number of the epoch</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">            :param outputPathConstants: Contains outputPath-related constants</span>
<span class="sd">            :type outputPathConstants: :py:class:`.OutputPathConstants`</span>
<span class="sd">            :param initialStructures: Name of the initial structures to copy</span>
<span class="sd">            :type initialStructures: str</span>
<span class="sd">            :param topologies: Topology object containing the set of topologies needed for the simulation</span>
<span class="sd">            :type topologies: :py:class:`.Topology`</span>
<span class="sd">            :param reportFileName: Name of the report file</span>
<span class="sd">            :type reportFileName: str</span>
<span class="sd">            :param processManager: Object to synchronize the possibly multiple processes</span>
<span class="sd">            :type processManager: :py:class:`.ProcessesManager`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputDir</span> <span class="o">=</span> <span class="n">outputPathConstants</span><span class="o">.</span><span class="n">epochOutputPathTempletized</span> <span class="o">%</span> <span class="n">epoch</span>
        <span class="n">structures_to_run</span> <span class="o">=</span> <span class="n">initialStructuresAsString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># load fixed constraints</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">readConstraints</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">topologies</span><span class="p">,</span> <span class="s2">&quot;new_constraints.txt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if the epoch is 0 the original equilibrated pdb files are taken as intial structures</span>
                <span class="n">equilibrated_structures</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">topologies</span><span class="p">,</span> <span class="s2">&quot;top*pdb&quot;</span><span class="p">))</span>
                <span class="n">structures_to_run</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">equilibrated_structures</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">getTrajNum</span><span class="p">)</span>
            <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputDir</span><span class="p">,</span> <span class="s2">&quot;checkpoint*.chk&quot;</span><span class="p">))</span>
            <span class="n">checkpoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">getTrajNum</span><span class="p">)</span>
        <span class="c1"># always read the prmtop files from disk to serve as communication</span>
        <span class="c1"># between diffrent processses</span>
        <span class="n">prmtops</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">topologies</span><span class="p">,</span> <span class="s2">&quot;*prmtop&quot;</span><span class="p">))</span>
        <span class="c1"># sort the prmtops according to the original topology order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prmtopFiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prmtops</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">getPrmtopNum</span><span class="p">)</span>
        <span class="c1"># To follow the same order as PELE (important for processor mapping)</span>
        <span class="n">structures_to_run</span> <span class="o">=</span> <span class="n">structures_to_run</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="p">[</span><span class="n">structures_to_run</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">structures_to_run</span> <span class="o">=</span> <span class="p">[</span><span class="n">structure</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="p">),</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">structures_to_run</span><span class="p">))]</span>
        <span class="n">structures_to_run</span> <span class="o">=</span> <span class="n">processManager</span><span class="o">.</span><span class="n">getStructureListPerReplica</span><span class="p">(</span><span class="n">structures_to_run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">)</span>
        <span class="n">startingFilesPairs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">prmtopFiles</span><span class="p">[</span><span class="n">topologies</span><span class="o">.</span><span class="n">getTopologyIndex</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">structure</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures_to_run</span><span class="p">]</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;Starting OpenMM Production Run of </span><span class="si">%d</span><span class="s2"> steps...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">productionLength</span><span class="p">)</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">)</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="n">epoch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">startingFiles</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">startingFilesPairs</span><span class="p">):</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>
                <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">processManager</span><span class="o">.</span><span class="n">id</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">]</span>
            <span class="n">workerNumber</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">runProductionSimulation</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">startingFiles</span><span class="p">,</span> <span class="n">workerNumber</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">reportFileName</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">ligandName</span><span class="p">,</span> <span class="n">processManager</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">)))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">get_workers_output</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">print_unbuffered</span><span class="p">(</span><span class="s2">&quot;OpenMM took </span><span class="si">%.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">))</span></div>

<div class="viewcode-block" id="MDSimulation.unifyReportNames"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.unifyReportNames">[docs]</a>    <span class="k">def</span> <span class="nf">unifyReportNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spawningReportName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Ensure that the reportName in the simulation parameters is the same</span>
<span class="sd">            as the one provided in the spawning parameters</span>

<span class="sd">            :param spawningReportName: Name of the report file provided in the spawning parameters</span>
<span class="sd">            :type spawningReportName: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="MDSimulation.createMultipleComplexesFilenames"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.createMultipleComplexesFilenames">[docs]</a>    <span class="k">def</span> <span class="nf">createMultipleComplexesFilenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numberOfSnapshots</span><span class="p">,</span> <span class="n">tmpInitialStructuresTemplate</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">equilibration</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the string to substitute the complexes in the PELE control file</span>

<span class="sd">            :param numberOfSnapshots: Number of complexes to write</span>
<span class="sd">            :type numberOfSnapshots: int</span>
<span class="sd">            :param tmpInitialStructuresTemplate: Template with the name of the initial strutctures</span>
<span class="sd">            :type tmpInitialStructuresTemplate: str</span>
<span class="sd">            :param iteration: Epoch number</span>
<span class="sd">            :type iteration: int</span>
<span class="sd">            :param equilibration: Flag to mark wether the complexes are part of an</span>
<span class="sd">                equilibration run</span>
<span class="sd">            :type equilibration: bool</span>

<span class="sd">            :returns: str with the files to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initialStructures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfSnapshots</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">initialStructures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpInitialStructuresTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">initialStructures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tmpInitialStructuresTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">numberOfSnapshots</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">)</span></div>

<div class="viewcode-block" id="MDSimulation.checkSimulationInterrupted"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.checkSimulationInterrupted">[docs]</a>    <span class="k">def</span> <span class="nf">checkSimulationInterrupted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputpath</span><span class="p">,</span> <span class="n">restart</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check wether the simulation was interrupted before finishing</span>

<span class="sd">            :param epoch: Epoch number</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">            :param outputpath: Simulation output path</span>
<span class="sd">            :type outputpath: str</span>
<span class="sd">            :param restart: Whether to restart a previous simulation</span>
<span class="sd">            :type restart: bool</span>

<span class="sd">            :returns: bool -- True if the simulations where interrupted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># to be implemented depending on implementation details</span>
        <span class="n">simulationpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">),</span> <span class="s2">&quot;checkpoint*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">simulationpath</span><span class="p">):</span>
            <span class="c1"># if the simulation does not have the restart option set we don&#39;t</span>
            <span class="c1"># want to restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">restart</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MDSimulation.cleanCheckpointFiles"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MDSimulation.cleanCheckpointFiles">[docs]</a>    <span class="k">def</span> <span class="nf">cleanCheckpointFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpointDir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Clean the restart files generated if the simulation was interrupted</span>
<span class="sd">            before finishing</span>

<span class="sd">            :param checkpointDir: Directory with the checkpoints</span>
<span class="sd">            :type checkpointDir: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># to be implemented depending on implementation details</span>
        <span class="n">checkpointsToRemove</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpointDir</span><span class="p">,</span> <span class="s2">&quot;checkpoint*.chk&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">checkpointsToRemove</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">files</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.TestSimulation">[docs]</a><span class="k">class</span> <span class="nc">TestSimulation</span><span class="p">(</span><span class="n">SimulationRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class used for testing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">SimulationRunner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">SIMULATION_TYPE</span><span class="o">.</span><span class="n">TEST</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>

<div class="viewcode-block" id="TestSimulation.getWorkingProcessors"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.TestSimulation.getWorkingProcessors">[docs]</a>    <span class="k">def</span> <span class="nf">getWorkingProcessors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the number of working processors, i.e. number of trajectories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">processors</span><span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="TestSimulation.runSimulation"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.TestSimulation.runSimulation">[docs]</a>    <span class="k">def</span> <span class="nf">runSimulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">initialStructuresAsString</span><span class="p">,</span> <span class="n">topologies</span><span class="p">,</span> <span class="n">reportFileName</span><span class="p">,</span> <span class="n">processManager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Copy file to test the rest of the AdaptivePELE procedure</span>

<span class="sd">            :param epoch: number of the epoch</span>
<span class="sd">            :type epoch: int</span>
<span class="sd">            :param outputPathConstants: Contains outputPath-related constants</span>
<span class="sd">            :type outputPathConstants: :py:class:`.OutputPathConstants`</span>
<span class="sd">            :param initialStructures: Name of the initial structures to copy</span>
<span class="sd">            :type initialStructures: str</span>
<span class="sd">            :param topologies: Topology object containing the set of topologies needed for the simulation</span>
<span class="sd">            :type topologies: :py:class:`.Topology`</span>
<span class="sd">            :param reportFileName: Name of the report file</span>
<span class="sd">            :type reportFileName: str</span>
<span class="sd">            :param processManager: Object to synchronize the possibly multiple processes</span>
<span class="sd">            :type processManager: :py:class:`.ProcessesManager`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ControlFileDictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;COMPLEXES&quot;</span><span class="p">:</span> <span class="n">initialStructuresAsString</span><span class="p">,</span>
                                 <span class="s2">&quot;PELE_STEPS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">peleSteps</span><span class="p">,</span>
                                 <span class="s2">&quot;BOX_RADIUS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">boxRadius</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepareControlFile</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">outputPathConstants</span><span class="p">,</span> <span class="n">ControlFileDictionary</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied</span><span class="p">:</span>
            <span class="n">tmp_sync</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpFolder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">processManager</span><span class="o">.</span><span class="n">syncFolder</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tmp_topology</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPathConstants</span><span class="o">.</span><span class="n">tmpFolder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">topologies</span><span class="o">.</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">processManager</span><span class="o">.</span><span class="n">syncFolder</span><span class="p">,</span> <span class="n">tmp_sync</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">topologies</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">tmp_topology</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">destination</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">tmp_sync</span><span class="p">,</span> <span class="n">processManager</span><span class="o">.</span><span class="n">syncFolder</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">tmp_topology</span><span class="p">,</span> <span class="n">topologies</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copied</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TestSimulation.makeWorkingControlFile"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.TestSimulation.makeWorkingControlFile">[docs]</a>    <span class="k">def</span> <span class="nf">makeWorkingControlFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workingControlFilename</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">inputTemplate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="ClusteringExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.ClusteringExitCondition">[docs]</a><span class="k">class</span> <span class="nc">ClusteringExitCondition</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntrajs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusterNum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrajs</span> <span class="o">=</span> <span class="n">ntrajs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">EXITCONDITION_TYPE</span><span class="o">.</span><span class="n">CLUSTERING</span>

<div class="viewcode-block" id="ClusteringExitCondition.checkExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.ClusteringExitCondition.checkExitCondition">[docs]</a>    <span class="k">def</span> <span class="nf">checkExitCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clustering</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Iterate over all unchecked cluster and check if the exit condtion</span>
<span class="sd">            is met</span>

<span class="sd">            :param clustering: Clustering object</span>
<span class="sd">            :type clustering: :py:class:`.Clustering`</span>

<span class="sd">            :returns: bool -- Returns True if the exit condition has been met</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newClusterNum</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">getNumberClusters</span><span class="p">()</span>
        <span class="n">clusterDiff</span> <span class="o">=</span> <span class="n">newClusterNum</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusterNum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusterNum</span> <span class="o">=</span> <span class="n">newClusterNum</span>
        <span class="k">return</span> <span class="n">clusterDiff</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrajs</span></div></div>


<div class="viewcode-block" id="MetricExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MetricExitCondition">[docs]</a><span class="k">class</span> <span class="nc">MetricExitCondition</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metricCol</span><span class="p">,</span> <span class="n">metricValue</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span> <span class="o">=</span> <span class="n">metricCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricValue</span> <span class="o">=</span> <span class="n">metricValue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">EXITCONDITION_TYPE</span><span class="o">.</span><span class="n">METRIC</span>
        <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span>

<div class="viewcode-block" id="MetricExitCondition.checkExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MetricExitCondition.checkExitCondition">[docs]</a>    <span class="k">def</span> <span class="nf">checkExitCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clustering</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Iterate over all clusters and check if the exit condtion</span>
<span class="sd">            is met</span>

<span class="sd">            :param clustering: Clustering object</span>
<span class="sd">            :type clustering: :py:class:`.Clustering`</span>

<span class="sd">            :returns: bool -- Returns True if the exit condition has been met</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clustering</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">getMetricFromColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metricValue</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="MetricMultipleTrajsExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MetricMultipleTrajsExitCondition">[docs]</a><span class="k">class</span> <span class="nc">MetricMultipleTrajsExitCondition</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metricCol</span><span class="p">,</span> <span class="n">metricValue</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">reportWildCard</span><span class="p">,</span> <span class="n">numTrajs</span><span class="p">,</span> <span class="n">nProcessors</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span> <span class="o">=</span> <span class="n">metricCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricValue</span> <span class="o">=</span> <span class="n">metricValue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">simulationTypes</span><span class="o">.</span><span class="n">EXITCONDITION_TYPE</span><span class="o">.</span><span class="n">METRICMULTIPLETRAJS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numTrajs</span> <span class="o">=</span> <span class="n">numTrajs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nProcessors</span> <span class="o">=</span> <span class="n">nProcessors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajsFound</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">reportWildCard</span>

<div class="viewcode-block" id="MetricMultipleTrajsExitCondition.checkExitCondition"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.MetricMultipleTrajsExitCondition.checkExitCondition">[docs]</a>    <span class="k">def</span> <span class="nf">checkExitCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputFolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Iterate over all reports and check if the exit condtion</span>
<span class="sd">            is met</span>

<span class="sd">            :param clustering: Clustering object</span>
<span class="sd">            :type clustering: :py:class:`.Clustering`</span>

<span class="sd">            :returns: bool -- Returns True if the exit condition has been met</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nProcessors</span><span class="p">):</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">loadtxtfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">%</span> <span class="n">j</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">report</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">metricValue</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajsFound</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajsFound</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numTrajs</span></div></div>


<div class="viewcode-block" id="RunnerBuilder"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.RunnerBuilder">[docs]</a><span class="k">class</span> <span class="nc">RunnerBuilder</span><span class="p">:</span>
<div class="viewcode-block" id="RunnerBuilder.build"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.RunnerBuilder.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulationRunnerBlock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Build the selected  SimulationRunner object</span>

<span class="sd">            :param simulationRunnerBlock: Block of the control file</span>
<span class="sd">                corresponding to the simulation step</span>
<span class="sd">            :type simulationRunnerBlock: dict</span>

<span class="sd">            :returns: :py:class:`.SimulationRunner` -- SimulationRunner object</span>
<span class="sd">                selected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulationType</span> <span class="o">=</span> <span class="n">simulationRunnerBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationType</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="n">paramsBlock</span> <span class="o">=</span> <span class="n">simulationRunnerBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">SimulationParameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">simulationType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationType</span><span class="o">.</span><span class="n">pele</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">processors</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">dataFolder</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">dataFolder</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">DATA_FOLDER</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">documentsFolder</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">documentsFolder</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">DOCUMENTS_FOLDER</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">PELE_EXECUTABLE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dataFolder</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">documentsFolder</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">executable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">ImproperParameterValueException</span><span class="p">(</span><span class="s2">&quot;PELE parameters not defined! Please ensure that you have defined the path to the PELE executable, the Data and Documents paths&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">templetizedControlFile</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">templetizedControlFile</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">iterations</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">peleSteps</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">peleSteps</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">seed</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">trajectoryName</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">trajectoryName</span><span class="p">)</span>
            <span class="n">peleDict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getPELEControlFileDict</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">templetizedControlFile</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">reportName</span><span class="p">,</span> <span class="n">trajectoryName</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getReportAndTrajectoryWildcard</span><span class="p">(</span><span class="n">peleDict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">trajectoryName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">trajectoryName</span> <span class="o">=</span> <span class="n">trajectoryName</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">trajectoryName</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">trajectoryName</span><span class="p">))</span>
            <span class="n">params</span><span class="o">.</span><span class="n">modeMovingBox</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">modeMovingBox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">modeMovingBoxBinding</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">SASAforBox</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">modeMovingBox</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">modeMovingBoxUnBinding</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">SASAforBox</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">params</span><span class="o">.</span><span class="n">columnSASA</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSASAcolumnFromControlFile</span><span class="p">(</span><span class="n">peleDict</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">boxCenter</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">boxCenter</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">boxRadius</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">boxRadius</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">runEquilibration</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">runEquilibration</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationMode</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationMode</span><span class="p">,</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationSelect</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationLength</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationLength</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">numberEquilibrationStructures</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationBoxRadius</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationBoxRadius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationRotationRange</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationRotationRange</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationTranslationRange</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationTranslationRange</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">srun</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">srun</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">trajsPerReplica</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">processors</span>
            <span class="n">params</span><span class="o">.</span><span class="n">numReplicas</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">params</span><span class="o">.</span><span class="n">srunParameters</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">srunParameters</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">srunParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">srunParameters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">srunParameters</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">srunParameters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">mpiParameters</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">mpiParameters</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">mpiParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">mpiParameters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">mpiParameters</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">mpiParameters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">exitConditionBlock</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">exitCondition</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exitConditionBlock</span><span class="p">:</span>
                <span class="n">exitConditionBuilder</span> <span class="o">=</span> <span class="n">ExitConditionBuilder</span><span class="p">()</span>
                <span class="n">params</span><span class="o">.</span><span class="n">exitCondition</span> <span class="o">=</span> <span class="n">exitConditionBuilder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">exitConditionBlock</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">templetizedControlFile</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">processors</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">PeleSimulation</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">simulationType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationType</span><span class="o">.</span><span class="n">md</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">iterations</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">processors</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">productionLength</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">productionLength</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">seed</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">reporterFreq</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">repoterfreq</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">numReplicas</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">numReplicas</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">devicesPerTrajectory</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">devicesPerTrajectory</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">trajsPerReplica</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">processors</span><span class="o">/</span><span class="n">params</span><span class="o">.</span><span class="n">numReplicas</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">trajsPerReplica</span><span class="o">*</span><span class="n">params</span><span class="o">.</span><span class="n">numReplicas</span> <span class="o">==</span> <span class="n">params</span><span class="o">.</span><span class="n">processors</span><span class="p">,</span> <span class="s2">&quot;Number of trajectories requested does not match the number of replicas&quot;</span>
            <span class="n">params</span><span class="o">.</span><span class="n">maxDevicesPerReplica</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">maxDevicesPerReplica</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">runEquilibration</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationLengthNVT</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationLengthNVT</span><span class="p">,</span> <span class="mi">200000</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">equilibrationLengthNPT</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">equilibrationLengthNPT</span><span class="p">,</span> <span class="mi">500000</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="s2">&quot;xtc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">md_supported_formats</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">ImproperParameterValueException</span><span class="p">(</span><span class="s2">&quot;Not supported </span><span class="si">%s</span><span class="s2"> format specified, supported formats are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">formats_md_string</span><span class="p">))</span>
            <span class="n">params</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">boxRadius</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">boxRadius</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">boxCenter</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">boxCenter</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">boxType</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">boxType</span><span class="p">,</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">sphere</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">cylinderBases</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">boxType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">cylinder</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">RequiredParameterMissingException</span><span class="p">(</span><span class="s2">&quot;To use a cylinder box you need to specify the basis points for the cylinder&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># round all coordinates to 3 decimals to fit into pdb format and</span>
                <span class="c1"># also ensure that they are numpy arrays</span>
                <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">boxType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">boxType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">sphere</span><span class="p">,</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">cylinder</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">ImproperParameterValueException</span><span class="p">(</span><span class="s2">&quot;Unknown </span><span class="si">%s</span><span class="s2"> box type, supported formats are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">boxType</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">sphere</span><span class="p">,</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">cylinder</span><span class="p">])))</span>
            <span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">ligandCharge</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">waterBoxSize</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">waterBoxSize</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">forcefield</span><span class="p">,</span> <span class="s2">&quot;ff99SB&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">nonBondedCutoff</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">nonBondedCutoff</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">Temperature</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">Temperature</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">runningPlatform</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">runningPlatform</span><span class="p">,</span> <span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">minimizationIterations</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">minimizationIterations</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">constraintsMin</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">constraintsMin</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">constraintsNVT</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">constraintsNVT</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">constraintsNPT</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">constraintsNPT</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">customparamspath</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">customparamspath</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">ligandsToRestrict</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">ligandsToRestrict</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">ligandName</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">ligandName</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">ImproperParameterValueException</span><span class="p">(</span><span class="s2">&quot;Both the ligand names and charges are necessary&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandName</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">params</span><span class="o">.</span><span class="n">ligandName</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">ligandName</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
                <span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandName</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandCharge</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">ImproperParameterValueException</span><span class="p">(</span><span class="s2">&quot;The same amount of ligand names and charges should be specified&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">cofactors</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">cofactors</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">postprocessing</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">postprocessing</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">boxCenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utilities</span><span class="o">.</span><span class="n">ImproperParameterValueException</span><span class="p">(</span><span class="s2">&quot;Ligand name is necessary to establish the box&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandsToRestrict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">boxCenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">cylinderBases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ligandName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">ligandsToRestrict</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">ligandName</span>
            <span class="k">return</span> <span class="n">MDSimulation</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">simulationType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationType</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">processors</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">destination</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">origin</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">iterations</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">peleSteps</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">peleSteps</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">seed</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">trajsPerReplica</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">processors</span>
            <span class="n">params</span><span class="o">.</span><span class="n">numReplicas</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">TestSimulation</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Unknown simulation type! Choices are: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">simulationTypes</span><span class="o">.</span><span class="n">SIMULATION_TYPE_TO_STRING_DICTIONARY</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div></div>


<div class="viewcode-block" id="ExitConditionBuilder"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.ExitConditionBuilder">[docs]</a><span class="k">class</span> <span class="nc">ExitConditionBuilder</span><span class="p">:</span>
<div class="viewcode-block" id="ExitConditionBuilder.build"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.ExitConditionBuilder.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitConditionBlock</span><span class="p">,</span> <span class="n">templetizedControlFile</span><span class="p">,</span> <span class="n">nProcessors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Build the selected exit condition object</span>

<span class="sd">            :param exitConditionBlock: Block of the control file</span>
<span class="sd">                corresponding to the exit condition</span>
<span class="sd">            :type exitConditionBlock: dict</span>

<span class="sd">            :returns: :py:class:`.MetricExitCondition` -- MetricExitCondition object</span>
<span class="sd">                selected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exitConditionType</span> <span class="o">=</span> <span class="n">exitConditionBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ExitConditionType</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="n">exitConditionParams</span> <span class="o">=</span> <span class="n">exitConditionBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exitConditionType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ExitConditionType</span><span class="o">.</span><span class="n">metric</span><span class="p">:</span>
            <span class="c1"># Start counting the columns by 1</span>
            <span class="n">metricCol</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">metricCol</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">metricValue</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">exitValue</span><span class="p">]</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In MetricExitCondition the parameter condition only accepts &gt; or &lt;, but </span><span class="si">%s</span><span class="s2"> was passed&quot;</span> <span class="o">%</span> <span class="n">condition</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">MetricExitCondition</span><span class="p">(</span><span class="n">metricCol</span><span class="p">,</span> <span class="n">metricValue</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">exitConditionType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ExitConditionType</span><span class="o">.</span><span class="n">metricMultipleTrajs</span><span class="p">:</span>
            <span class="c1"># Start counting the columns by 1</span>
            <span class="n">metricCol</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">metricCol</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">metricValue</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">exitValue</span><span class="p">]</span>
            <span class="n">numTrajs</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">numTrajs</span><span class="p">]</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In MetricMultipleTrajsExitCondition the parameter condition only accepts &gt; or &lt;, but </span><span class="si">%s</span><span class="s2"> was passed&quot;</span> <span class="o">%</span> <span class="n">condition</span><span class="p">)</span>
            <span class="n">peleControlFileDict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getPELEControlFileDict</span><span class="p">(</span><span class="n">templetizedControlFile</span><span class="p">)</span>
            <span class="n">reportWildCard</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getReportAndTrajectoryWildcard</span><span class="p">(</span><span class="n">peleControlFileDict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">MetricMultipleTrajsExitCondition</span><span class="p">(</span><span class="n">metricCol</span><span class="p">,</span> <span class="n">metricValue</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">reportWildCard</span><span class="p">,</span> <span class="n">numTrajs</span><span class="p">,</span> <span class="n">nProcessors</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">exitConditionType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ExitConditionType</span><span class="o">.</span><span class="n">clustering</span><span class="p">:</span>
            <span class="n">ntrajs</span> <span class="o">=</span> <span class="n">exitConditionParams</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">SimulationParams</span><span class="o">.</span><span class="n">trajectories</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ClusteringExitCondition</span><span class="p">(</span><span class="n">ntrajs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Unknown exit condition type! Choices are: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">simulationTypes</span><span class="o">.</span><span class="n">EXITCONDITION_TYPE_TO_STRING_DICTIONARY</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div></div>


<div class="viewcode-block" id="updateConstraints"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.updateConstraints">[docs]</a><span class="k">def</span> <span class="nf">updateConstraints</span><span class="p">(</span><span class="n">constraints_orig</span><span class="p">,</span> <span class="n">constraints_map</span><span class="p">):</span>
    <span class="n">new_const</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">constraints_orig</span><span class="p">:</span>
        <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">constr</span>
        <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">atom1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">atom2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">atom1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints_map</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">atom1</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="n">atom2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraints_map</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">atom2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="n">new_const</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atom1</span><span class="p">]),</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atom2</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dist</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">new_const</span></div>

<div class="viewcode-block" id="processTraj"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.processTraj">[docs]</a><span class="k">def</span> <span class="nf">processTraj</span><span class="p">(</span><span class="n">input_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align a single trajectory file (helper function for parallelization)</span>

<span class="sd">        :param input_files: Tuple with (trajectory_file, topology_file)</span>
<span class="sd">        :type input_files: tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># try if we have a complete installation of mdtraj, if not (PCPower</span>
        <span class="c1"># cluster) run the MDAnalysis version</span>
        <span class="n">processTraj_mdtraj</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">processTraj_mdanalysis</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span></div>

<div class="viewcode-block" id="processTraj_mdtraj"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.processTraj_mdtraj">[docs]</a><span class="k">def</span> <span class="nf">processTraj_mdtraj</span><span class="p">(</span><span class="n">input_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align a single trajectory file (helper function for parallelization)</span>

<span class="sd">        :param input_files: Tuple with (trajectory_file, topology_file)</span>
<span class="sd">        :type input_files: tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">traj_file</span><span class="p">,</span> <span class="n">top_file</span> <span class="o">=</span> <span class="n">input_files</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">traj_file</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_file</span><span class="p">)</span>
    <span class="n">backbone_selection</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;backbone&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">backbone_selection</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># if no protein is found we will not try to align the system, as it is</span>
        <span class="c1"># not clear what would be the optimal procedure</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Since no receptor is found, system will not be aligned&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">t</span><span class="o">.</span><span class="n">image_molecules</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">superpose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atom_indices</span><span class="o">=</span><span class="n">backbone_selection</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">traj_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="processTraj_mdanalysis"><a class="viewcode-back" href="../../../AdaptivePELE.simulation.html#AdaptivePELE.simulation.simulationrunner.processTraj_mdanalysis">[docs]</a><span class="k">def</span> <span class="nf">processTraj_mdanalysis</span><span class="p">(</span><span class="n">input_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align a single trajectory file (helper function for parallelization)</span>

<span class="sd">        :param input_files: Tuple with (trajectory_file, topology_file)</span>
<span class="sd">        :type input_files: tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">traj_file</span><span class="p">,</span> <span class="n">top_file</span> <span class="o">=</span> <span class="n">input_files</span>
    <span class="n">mobile</span> <span class="o">=</span> <span class="n">MDA</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">top_file</span><span class="p">)</span>
    <span class="n">new_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_new</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">traj_file</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">MDA</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">top_file</span><span class="p">,</span> <span class="n">traj_file</span><span class="p">)</span>
    <span class="n">backbone_selection</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s2">&quot;backbone&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">backbone_selection</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># if no protein is found we will not try to align the system, as it is</span>
        <span class="c1"># not clear what would be the optimal procedure</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Since no receptor is found, system will not be aligned&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">t</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">compound</span><span class="o">=</span><span class="s2">&quot;residues&quot;</span><span class="p">)</span>
    <span class="n">alignment</span> <span class="o">=</span> <span class="n">align</span><span class="o">.</span><span class="n">AlignTraj</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mobile</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;backbone&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">new_file</span><span class="p">)</span>
    <span class="n">alignment</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">traj_file</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Daniel Lecina, Joan Francesc Gilabert.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>